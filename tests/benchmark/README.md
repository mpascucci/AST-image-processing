# Improc benchmarking python script
Benchmarks improc performance against a golden set of known results.
Prints out summary statistics:

- % of antibiotic disks found

- Categorization of results: Exception, No Pellets Found, or Pellets found

- Distribution of difference between expected and actual inhibition zone diameter

- % of antiiotic name matches

Displays 2 histograms:
- Distribution of errors regarding the number of antibiotic disks found

- Distribution of difference between actual and expected inhibition zone diameters

# Usage:

1. Check `improc/README.md` for C++<->python setup & troubleshooting tips.

2. If you want to create a new golden file, see "creating golden files" below.

3. Download any images referenced by the golden yml file to a directory (by default, `tests/benchmark/images`).
Amman images are found [here](https://drive.google.com/open?id=1nyb1L9lxmx6PSvdTvz_umnFJ0E-GAwp-) if you have access. Images from the phase 1 evaluation are found [here](https://drive.google.com/drive/folders/1x8I6ccTPPSR-YXguota1Fm8_X78Aw5Qa?usp=sharing).

4. Optional: If you want benchmark.sh to run faster and don't need to change
   preprocessing implementations across different runs, then generate
   preprocessing pickle files:
   `benchmark$ python3 -m preprocess_img $images_dir [-o preprocess_pickle_dir]`

5. Run benchmark.sh.
` sh benchmark.sh [-nb] [-d] [-c golden_file.yaml] [-i image_dir] [-p preprocess_pickle_dir]`

# Benchmark.sh args:

- `-nb or --nobuild`: Skip build. You should re-build (omit `nb`) whenever you want to test new C++, .pyd, or .pyx code. You don't need to rebuild to test new vanilla python code.

-  `-d or --display`: Display overlaid results per-AST.

- `-c path` or `--config path`: Path to the file containing expected AST
results. Defaults to `annotations/amman/amman_golden.yml`.

One of the following is required. `p` takes priority over `i`.

- `p some_dir` or `--preproc_dir some_dir`: Path of the directory containing
pickle files generated by preproc.py. If provided, the script will not run
preprocessing, and will run faster. If not provided, the script will preprocess
each image, and will run slower. 

- `-i some_dir` or `--image_dir some_dir`: Path of the directory containing AST images. 


# Examples:
* Build and run, and display results per-AST:
`benchmark$ sh benchmark.sh -d `

* Provide the optional arguments:
`benchmark$ sh benchmark.sh -d -c some_golden_file.yaml -i path/to/images`

* Run with preprocessing input (faster, but uses the same preprocessing input across runs):

Run once (slow):

`python3 -m preprocess_img images -o pickled_preprocs`

Run many times (fast):

`benchmark$ sh benchmark.sh -p pickled_preprocs`

* Run without building:
`benchmark$ sh benchmark.sh -nb -d`

* Run without building and without displaying results per-AST:
`benchmark$ sh benchmark.sh -nb`

# Creating golden YML files 

Golden YML files have the following format:
```
ast_image_filename1.jpg:
- {diameter: 1.0, label: atb1, sir: S}
- {diameter: 2.0, label: atb1, sir: null}
- {diameter: 3.0, label: atb2, sir: R}
ast_image_filename2.jpg:
- {diameter: 1.0, label: atb2, sir: S}
- {diameter: 2.0, label: atb3, sir: S}
```
Depending on what data format you start with, you may choose to:

* Option 1: Manually create YAML files
* Option 2: Write your own custom script to write a yaml file
* Option 3: Create a new class implementing the interface `Annotations_set`. For example: [AST_annotation_Amman](https://bitbucket.org/astappteam/mobile_app/src/dev/improc/tests/benchmark/benchmark_tools/usecases/amman/__init__.py). Call its `write_yaml` method. (The interface `Annotations_set` already implemented `write_yaml`; you just need to write code to parse your input file).

Note: Currently cannot create viable YAML for Creteil because there are no image filenames in the annotations data.  TODO: find image names, and create creteil_golden.yml.

```
import benchmark_tools as bt
amman_set = bt.amman.Annotations_set_Amman("annotations/amman/amman_golden.csv")
amman_set.write_yaml("annotations/amman/amman_golden.yml")
```


# Demo: 
```
sh benchmark.sh -nb -d -c annotations/amman/amman_golden.yml -i images
############## ASTApp benchmarking starting on 205 files

processing file:  images/20180716-ECO-207.JPG

processing file:  images/20180716-SAU-204.JPG
...

------------ Summary Results -----------
% of disks found:                98.41%
% of diameter diffs <1mm:        89.47%
% of antibiotic name matches:    91.94%
% of exceptions:                 0.00%
Diameter diff quantiles:         0.29 0.64 0.9
```

AST display:

![missing image](https://bitbucket.org/repo/BkGM4Mp/images/3489278573-benchmark_ast.png "AST display example")
(3 more ASTs omitted)

Summary pie charts:
![missing image](https://bitbucket.org/repo/BkGM4Mp/images/2051903809-fig1_with_max_pellet_size.png "Summary pie charts")

Histogram of diameter diff per-pellet:

![missing image](https://bitbucket.org/repo/BkGM4Mp/images/1578069852-fig2_with_max_pellet_size.png "Diameter diff histogram")

Histogram of number of pellets found per-antibiotic:

![missing image](https://bitbucket.org/repo/BkGM4Mp/images/1371280598-fig3_with_max_pellet_size.png "Number of pellets histogram")
